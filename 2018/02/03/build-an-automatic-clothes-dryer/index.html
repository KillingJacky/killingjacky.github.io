<!DOCTYPE html>




<html class="theme-next mist" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Source Sans Pro:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="tech,mqtt,home-assistant," />










<meta name="description" content="Have you ever been bothered that after a perfect bath you have to stand in the cold winter wind more than one minute to put your underwear onto the clothes dryer, just because the old crank doesn’t w">
<meta name="keywords" content="tech,mqtt,home-assistant">
<meta property="og:type" content="article">
<meta property="og:title" content="Build an Automatic Clothes Dryer">
<meta property="og:url" content="http://forkthings.com/2018/02/03/build-an-automatic-clothes-dryer/index.html">
<meta property="og:site_name" content="Fork Things">
<meta property="og:description" content="Have you ever been bothered that after a perfect bath you have to stand in the cold winter wind more than one minute to put your underwear onto the clothes dryer, just because the old crank doesn’t w">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://forkthings.com/2018/02/03/build-an-automatic-clothes-dryer/20180203_140403.jpg">
<meta property="og:image" content="http://forkthings.com/2018/02/03/build-an-automatic-clothes-dryer/20180203_140419.jpg">
<meta property="og:image" content="http://forkthings.com/2018/02/03/build-an-automatic-clothes-dryer/20180203_140606.jpg">
<meta property="og:image" content="http://forkthings.com/2018/02/03/build-an-automatic-clothes-dryer/20180203_140507.jpg">
<meta property="og:image" content="http://forkthings.com/2018/02/03/build-an-automatic-clothes-dryer/20180203_140519.jpg">
<meta property="og:image" content="http://forkthings.com/2018/02/03/build-an-automatic-clothes-dryer/20180203_140529.jpg">
<meta property="og:image" content="http://forkthings.com/2018/02/03/build-an-automatic-clothes-dryer/20180203_140635.jpg">
<meta property="og:image" content="http://forkthings.com/2018/02/03/build-an-automatic-clothes-dryer/20180203_140703.jpg">
<meta property="og:image" content="http://forkthings.com/2018/02/03/build-an-automatic-clothes-dryer/20180203_140709.jpg">
<meta property="og:image" content="http://forkthings.com/2018/02/03/build-an-automatic-clothes-dryer/board.jpg">
<meta property="og:image" content="https://statics3.seeedstudio.com/seeed/img/2016-08/64yfQxGqSe4fzpd2l6Rcy2xo.jpg">
<meta property="og:image" content="http://forkthings.com/2018/02/03/build-an-automatic-clothes-dryer/diagram.png">
<meta property="og:image" content="http://forkthings.com/2018/02/03/build-an-automatic-clothes-dryer/homeassistant.png">
<meta property="og:updated_time" content="2018-02-03T10:41:13.545Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Build an Automatic Clothes Dryer">
<meta name="twitter:description" content="Have you ever been bothered that after a perfect bath you have to stand in the cold winter wind more than one minute to put your underwear onto the clothes dryer, just because the old crank doesn’t w">
<meta name="twitter:image" content="http://forkthings.com/2018/02/03/build-an-automatic-clothes-dryer/20180203_140403.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://forkthings.com/2018/02/03/build-an-automatic-clothes-dryer/"/>





  <title>Build an Automatic Clothes Dryer | Fork Things</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-46589105-7', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Fork Things</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Fork the connectivity of every physical things in the world.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://forkthings.com/2018/02/03/build-an-automatic-clothes-dryer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="KillingJacky">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fork Things">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Build an Automatic Clothes Dryer</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-03T15:00:00+00:00">
                2018-02-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/03/build-an-automatic-clothes-dryer/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/02/03/build-an-automatic-clothes-dryer/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="/2018/02/03/build-an-automatic-clothes-dryer/20180203_140403.jpg" alt=""></p>
<p>Have you ever been bothered that after a perfect bath you have to stand in the cold winter wind more than one minute to put your underwear onto the clothes dryer, just because the old crank doesn’t work fluently? I have, it’s really painful for a person like me that doesn’t like cold weather in the winter. What I need is an automatic dryer that I can control remotely in the room. I built one, with less money but flexible functionalities.</p>
<p>Let’s see what features it has:</p>
<ul>
<li>Motor driven</li>
<li>Mechanical position limitation</li>
<li>Linear positioning with optical encoder</li>
<li>Linear height control with analog rotator</li>
<li>RF control</li>
<li>MQTT control</li>
</ul>
<a id="more"></a>
<p>I fixed it on the wall of balcony of my house, replaced the old crank of this liftable clothes dryer.</p>
<p><img src="/2018/02/03/build-an-automatic-clothes-dryer/20180203_140419.jpg" alt=""></p>
<p><img src="/2018/02/03/build-an-automatic-clothes-dryer/20180203_140606.jpg" alt=""></p>
<p><img src="/2018/02/03/build-an-automatic-clothes-dryer/20180203_140507.jpg" alt=""></p>
<p>The motor controller with RF - I bought it from taobao.com of alibaba.</p>
<p><img src="/2018/02/03/build-an-automatic-clothes-dryer/20180203_140519.jpg" alt=""></p>
<p>The closure is made of a gift box. I cut a window on the top to let the lifting rope go through.</p>
<p><img src="/2018/02/03/build-an-automatic-clothes-dryer/20180203_140529.jpg" alt=""></p>
<p>This is all the stuff inside the box, including motor, rope spooler, optical encoder, another controller board and a DC-DC convertor.</p>
<p><img src="/2018/02/03/build-an-automatic-clothes-dryer/20180203_140635.jpg" alt=""></p>
<p>Rope spooler.</p>
<p><img src="/2018/02/03/build-an-automatic-clothes-dryer/20180203_140703.jpg" alt=""></p>
<p><img src="/2018/02/03/build-an-automatic-clothes-dryer/20180203_140709.jpg" alt=""></p>
<p>This is another controller board which communicates with the motor controller. The motor controller has extensional GPIOs for controlling the motor to UP/DOWN/STOP from outside.</p>
<p><img src="/2018/02/03/build-an-automatic-clothes-dryer/board.jpg" alt=""></p>
<p>The first function I want to have is the MQTT control, with which I can include this auto dryer into my home-assistant system. This means that I need the WiFi connection for the controller, I used the <a href="https://www.seeedstudio.com/LinkIt-Smart-7688-Duo-p-2574.html" target="_blank" rel="noopener">Linkit Smart 7688 Duo</a> board from <a href="seeedstudio.com">SeeedStudio</a>. This board is a powerful little piece with low cost, it has:</p>
<ul>
<li>580 MHz MIPS CPU </li>
<li>Single input single output(1T1R) Wi-Fi 802.11 b/g/n (2.4G) </li>
<li>Pin-out for GPIO, I2C, SPI, SPIS, UART, PWM and Ethernet Port </li>
<li>32MB Flash and 128MB DDR2 RAM</li>
<li>USB host</li>
<li>Micro SD slot </li>
<li>Support for Arduino (ATmega32U4) </li>
</ul>
<p><img src="https://statics3.seeedstudio.com/seeed/img/2016-08/64yfQxGqSe4fzpd2l6Rcy2xo.jpg" alt="7688 Duo"></p>
<p>So I got a system diagram like this:</p>
<p><img src="/2018/02/03/build-an-automatic-clothes-dryer/diagram.png" alt=""></p>
<h2 id="Programming"><a href="#Programming" class="headerlink" title="Programming"></a>Programming</h2><h3 id="Arduino"><a href="#Arduino" class="headerlink" title="Arduino"></a>Arduino</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;avr/eeprom.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;EEPROM.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Wire.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Encoder.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;SoftwareSerial.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//status</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ST_STOP                 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ST_UP                   1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ST_TITTLE_UP            2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ST_DOWN                 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ST_TITTLE_DOWN          4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ST_MUST_STOP            5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ST_RUN                  6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ST_IDLE                 100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// pins</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIN_KNOB                A0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIN_UP                  7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIN_STOP                6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIN_DOWN                5</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIN_ENC_A               2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIN_ENC_B               3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// knob</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THRES_KNOB                  25     <span class="comment">//3cm resolution</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KNOB_AVG_TIMES              10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KNOB_WAIT_TIME_BEFORE_STOP  100    <span class="comment">//ms</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// motor</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MOTOR_CTRL_PULSE            250    <span class="comment">//ms</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// others</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ENABLE_SLOWTASK             true</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SLOW_LOOP_DURATION          10000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TITTLE_UP_THRES             200</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TITTLE_DOWN_THRES           200</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEADZONE                    50</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEBUG_SER                   Serial</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMM_SER                    Serial1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> key = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> status = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> last_status = <span class="number">-1</span>;</span><br><span class="line">boolean auto_mode = <span class="literal">false</span>;</span><br><span class="line">boolean was_moving = <span class="literal">false</span>;</span><br><span class="line">boolean triggered = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">int32_t</span> cur_pos, target_pos, total_len, last_saved_pos;</span><br><span class="line"><span class="keyword">int32_t</span> trigger_all_lux, trigger_half_lux;</span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> last_slow_loop_time, last_save_pos_time;</span><br><span class="line"><span class="keyword">float</span> temp = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> lux = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> cur_knob, last_knob, sum_knob, knob_sum_cnt;</span><br><span class="line"><span class="keyword">bool</span> knob_moving = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">long</span> last_knob_move_time;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//SoftwareSerial mySerial(10, 11); // RX, TX</span></span><br><span class="line"><span class="function">Encoder <span class="title">encoder</span><span class="params">(PIN_ENC_A, PIN_ENC_B)</span></span>;</span><br><span class="line"><span class="keyword">long</span> encoder_pos;</span><br><span class="line"></span><br><span class="line">String recv_buffer;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  pinMode(PIN_UP, OUTPUT);</span><br><span class="line">  pinMode(PIN_STOP, OUTPUT);</span><br><span class="line">  pinMode(PIN_DOWN, OUTPUT);</span><br><span class="line"></span><br><span class="line">  digitalWrite(PIN_UP, <span class="number">1</span>);</span><br><span class="line">  digitalWrite(PIN_STOP, <span class="number">1</span>);</span><br><span class="line">  digitalWrite(PIN_DOWN, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  COMM_SER.begin(<span class="number">57600</span>);</span><br><span class="line">  DEBUG_SER.begin(<span class="number">115200</span>);</span><br><span class="line"></span><br><span class="line">  COMM_SER.setTimeout(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">  DEBUG_SER.println(<span class="string">"&gt; on-start..."</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  save_pos_to_eeprom(0);</span></span><br><span class="line"><span class="comment">//  save_len_to_eeprom(2000);</span></span><br><span class="line"></span><br><span class="line">  restore_len_from_eeprom(&amp;total_len);</span><br><span class="line">  restore_pos_from_eeprom(&amp;cur_pos);</span><br><span class="line"></span><br><span class="line">  target_pos = cur_pos;</span><br><span class="line">  encoder.write(cur_pos);</span><br><span class="line">  last_saved_pos = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  last_knob = cur_knob = analogRead(PIN_KNOB);</span><br><span class="line">  sum_knob = knob_sum_cnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  recv_buffer.reserve(<span class="number">64</span>);</span><br><span class="line"></span><br><span class="line">  DEBUG_SER.print(<span class="string">"&gt; init over!\r\n&gt; cur_pos: "</span>);</span><br><span class="line">  DEBUG_SER.print(cur_pos);</span><br><span class="line">  DEBUG_SER.print(<span class="string">", total_len: "</span>);</span><br><span class="line">  DEBUG_SER.println(total_len);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  process_air_commands();</span><br><span class="line">  </span><br><span class="line">  process_knob_action();</span><br><span class="line"></span><br><span class="line">  process_position_fixing();</span><br><span class="line">  </span><br><span class="line">  state_machine_process_state();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//slow task</span></span><br><span class="line">  <span class="keyword">if</span> (millis() - last_slow_loop_time &gt; SLOW_LOOP_DURATION &amp;&amp; ENABLE_SLOWTASK)</span><br><span class="line">  &#123;</span><br><span class="line">    last_slow_loop_time = millis();</span><br><span class="line">    do_slow_task();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  delay(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">process_air_commands</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> cnt = COMM_SER.available();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (cnt &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">//    //clear the string</span></span><br><span class="line"><span class="comment">//    for (int i = 0; i &lt; recv_buffer.length(); i++) &#123;</span></span><br><span class="line"><span class="comment">//      recv_buffer.setCharAt(i, '\0');</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    //fill the string</span></span><br><span class="line"><span class="comment">//    int j = 0;</span></span><br><span class="line"><span class="comment">//    while (cnt-- &gt; 0) &#123;</span></span><br><span class="line"><span class="comment">//      recv_buffer.setCharAt(j, COMM_SER.read());</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">    recv_buffer = COMM_SER.readStringUntil(<span class="string">'\r'</span>);</span><br><span class="line"></span><br><span class="line">    DEBUG_SER.print(<span class="string">"&gt; recv string: "</span>);</span><br><span class="line">    DEBUG_SER.println(recv_buffer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//parse the string</span></span><br><span class="line">    <span class="keyword">if</span> (recv_buffer.indexOf(<span class="string">"C0"</span>) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="comment">//calibrate pos 0</span></span><br><span class="line">      target_pos = cur_pos = <span class="number">-20</span>;</span><br><span class="line">      encoder.write(<span class="number">0</span>);</span><br><span class="line">      save_pos_to_eeprom(cur_pos);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (recv_buffer.indexOf(<span class="string">"C100"</span>) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="comment">//calibrate pos 100</span></span><br><span class="line">      <span class="keyword">if</span> (cur_pos &gt; <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          total_len = cur_pos - <span class="number">20</span>;</span><br><span class="line">          save_pos_to_eeprom(cur_pos); </span><br><span class="line">          save_len_to_eeprom(total_len);</span><br><span class="line">          DEBUG_SER.print(<span class="string">"&gt; total_len: "</span>);</span><br><span class="line">          DEBUG_SER.println(total_len); </span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (recv_buffer.indexOf(<span class="string">"OPEN"</span>) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      target_pos = <span class="number">0</span>;</span><br><span class="line">      triggered = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (recv_buffer.indexOf(<span class="string">"CLOSE"</span>) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      target_pos = total_len;</span><br><span class="line">      triggered = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (recv_buffer.indexOf(<span class="string">"STOP"</span>) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      target_pos = cur_pos;</span><br><span class="line">      triggered = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (recv_buffer.indexOf(<span class="string">"POS"</span>) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      String pos_str = recv_buffer.substring(recv_buffer.indexOf(<span class="string">"POS"</span>) + <span class="number">3</span>);</span><br><span class="line">      <span class="keyword">int</span> pos = pos_str.toInt();</span><br><span class="line">      DEBUG_SER.print(<span class="string">"&gt; recv pos: "</span>);</span><br><span class="line">      DEBUG_SER.println(pos);</span><br><span class="line">      <span class="keyword">if</span> (pos &gt;= <span class="number">0</span> &amp;&amp; pos &lt;= <span class="number">100</span>) &#123;</span><br><span class="line">        target_pos = <span class="built_in">map</span>(pos, <span class="number">0</span>, <span class="number">100</span>, total_len, <span class="number">0</span>);</span><br><span class="line">        triggered = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    recv_buffer = <span class="string">""</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_pos_to_air</span><span class="params">(<span class="keyword">int32_t</span> pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> p = <span class="built_in">map</span>(pos, <span class="number">0</span>, total_len, <span class="number">100</span>, <span class="number">0</span>);</span><br><span class="line">  COMM_SER.println(p, DEC);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (p &lt;= <span class="number">2</span>) &#123;</span><br><span class="line">    COMM_SER.println(<span class="string">"closed"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (p &gt;= <span class="number">98</span>) &#123;</span><br><span class="line">    COMM_SER.println(<span class="string">"open"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">process_knob_action</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  sum_knob += analogRead(PIN_KNOB);</span><br><span class="line">  knob_sum_cnt++;</span><br><span class="line">  <span class="keyword">if</span> (knob_sum_cnt &gt;= KNOB_AVG_TIMES) &#123;</span><br><span class="line">    knob_sum_cnt = <span class="number">0</span>;</span><br><span class="line">    cur_knob = sum_knob / KNOB_AVG_TIMES;</span><br><span class="line">    sum_knob = <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">abs</span>(cur_knob - last_knob) &gt; THRES_KNOB) &#123;</span><br><span class="line">    knob_moving = <span class="literal">true</span>;</span><br><span class="line">    last_knob_move_time = millis();</span><br><span class="line">    last_knob = cur_knob;</span><br><span class="line"></span><br><span class="line">    DEBUG_SER.print(<span class="string">"&gt; cur_knob: "</span>);</span><br><span class="line">    DEBUG_SER.print(cur_knob);</span><br><span class="line">    DEBUG_SER.print(<span class="string">", delta knob: "</span>);</span><br><span class="line">    DEBUG_SER.println(<span class="built_in">abs</span>(cur_knob - last_knob));</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (knob_moving &amp;&amp; (millis() - last_knob_move_time) &gt; KNOB_WAIT_TIME_BEFORE_STOP) &#123;</span><br><span class="line">      knob_moving = <span class="literal">false</span>;</span><br><span class="line">      <span class="comment">// just stop, should take some actions</span></span><br><span class="line">      target_pos = <span class="built_in">map</span>(last_knob, <span class="number">0</span>, <span class="number">1023</span>, <span class="number">0</span>, total_len);</span><br><span class="line">      triggered = <span class="literal">true</span>;</span><br><span class="line">      </span><br><span class="line">      DEBUG_SER.print(<span class="string">"&gt;target pos was set by knob: "</span>);</span><br><span class="line">      DEBUG_SER.println(target_pos);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   Position fixing and state transfer</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">process_position_fixing</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">//read position</span></span><br><span class="line">  cur_pos = encoder.read();</span><br><span class="line"><span class="comment">//  DEBUG_SER.print("&gt; cur pos: ");</span></span><br><span class="line"><span class="comment">//  DEBUG_SER.println(cur_pos);</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//down</span></span><br><span class="line">  <span class="keyword">if</span> (target_pos - cur_pos &gt; DEADZONE &amp;&amp; triggered)</span><br><span class="line">  &#123;</span><br><span class="line"><span class="comment">//    if (target_pos - cur_pos &lt; TITTLE_DOWN_THRES)</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//      status = ST_TITTLE_DOWN;</span></span><br><span class="line"><span class="comment">//    &#125; else</span></span><br><span class="line">      status = ST_DOWN;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//up</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (target_pos - cur_pos &lt; -DEADZONE &amp;&amp; triggered)</span><br><span class="line">  &#123;</span><br><span class="line"><span class="comment">//    if (target_pos - cur_pos &gt; -TITTLE_UP_THRES)</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//      status = ST_TITTLE_UP;</span></span><br><span class="line"><span class="comment">//    &#125; else</span></span><br><span class="line">      status = ST_UP;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (triggered)</span><br><span class="line">  &#123;</span><br><span class="line">    status = ST_STOP;</span><br><span class="line">    triggered = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">state_machine_process_state</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (status)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> ST_UP:</span><br><span class="line">      <span class="keyword">if</span> (last_status != ST_UP) &#123;</span><br><span class="line">        motor_up();</span><br><span class="line">        was_moving = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (millis() - last_save_pos_time &gt; <span class="number">5000</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        save_pos_to_eeprom(cur_pos); last_save_pos_time = millis();</span><br><span class="line">        send_pos_to_air(cur_pos);</span><br><span class="line">      &#125;</span><br><span class="line">      last_status = ST_UP;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"><span class="comment">//    case ST_TITTLE_UP:</span></span><br><span class="line"><span class="comment">//      motor_up();</span></span><br><span class="line"><span class="comment">//      delay(abs(cur_pos - target_pos));</span></span><br><span class="line"><span class="comment">//      motor_stop();</span></span><br><span class="line"><span class="comment">//      delay(10);</span></span><br><span class="line"><span class="comment">//      was_moving = true;</span></span><br><span class="line"><span class="comment">//      last_status = ST_TITTLE_UP;</span></span><br><span class="line"><span class="comment">//      break;</span></span><br><span class="line">    <span class="keyword">case</span> ST_DOWN:</span><br><span class="line">      <span class="keyword">if</span> (last_status != ST_DOWN) &#123;</span><br><span class="line">        motor_down();</span><br><span class="line">        was_moving = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (millis() - last_save_pos_time &gt; <span class="number">5000</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        save_pos_to_eeprom(cur_pos); last_save_pos_time = millis();</span><br><span class="line">        send_pos_to_air(cur_pos);</span><br><span class="line">      &#125;</span><br><span class="line">      last_status = ST_DOWN;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"><span class="comment">//    case ST_TITTLE_DOWN:</span></span><br><span class="line"><span class="comment">//      motor_down();</span></span><br><span class="line"><span class="comment">//      delay(abs(cur_pos - target_pos));</span></span><br><span class="line"><span class="comment">//      motor_stop();</span></span><br><span class="line"><span class="comment">//      delay(100);</span></span><br><span class="line"><span class="comment">//      was_moving = true;</span></span><br><span class="line"><span class="comment">//      last_status = ST_TITTLE_DOWN;</span></span><br><span class="line"><span class="comment">//      break;</span></span><br><span class="line">    <span class="keyword">case</span> ST_MUST_STOP:</span><br><span class="line">    <span class="keyword">case</span> ST_STOP:</span><br><span class="line">      <span class="keyword">if</span> (last_status != ST_STOP) motor_stop();</span><br><span class="line">      <span class="keyword">if</span> (was_moving)</span><br><span class="line">      &#123;</span><br><span class="line">        was_moving = <span class="literal">false</span>;</span><br><span class="line">        save_pos_to_eeprom(cur_pos); last_save_pos_time = millis();</span><br><span class="line">        send_pos_to_air(cur_pos);</span><br><span class="line">      &#125;</span><br><span class="line">      last_status = ST_STOP;</span><br><span class="line">      <span class="keyword">break</span>;      </span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_slow_task</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  DEBUG_SER.println(<span class="string">"&gt; ---- slow task start ----"</span>);</span><br><span class="line">  DEBUG_SER.print(<span class="string">"# cur pos: "</span>);</span><br><span class="line">  DEBUG_SER.println(cur_pos);</span><br><span class="line">  DEBUG_SER.print(<span class="string">"# target pos: "</span>);</span><br><span class="line">  DEBUG_SER.println(target_pos);</span><br><span class="line">  DEBUG_SER.print(<span class="string">"# status: "</span>);</span><br><span class="line">  DEBUG_SER.println(status);</span><br><span class="line">  <span class="keyword">if</span> (cur_pos != last_saved_pos) &#123;</span><br><span class="line">    save_pos_to_eeprom(cur_pos); last_save_pos_time = millis();</span><br><span class="line">    send_pos_to_air(cur_pos);</span><br><span class="line">  &#125;</span><br><span class="line">  DEBUG_SER.println(<span class="string">"&gt; ---- slow task end ----"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">motor_up</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  DEBUG_SER.println(<span class="string">"!!! up"</span>);</span><br><span class="line">  pinMode(PIN_UP, OUTPUT);</span><br><span class="line">  digitalWrite(PIN_UP, <span class="number">0</span>);</span><br><span class="line">  delay(MOTOR_CTRL_PULSE);</span><br><span class="line">  digitalWrite(PIN_UP, <span class="number">1</span>);</span><br><span class="line">  pinMode(PIN_UP, INPUT_PULLUP);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">motor_down</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  DEBUG_SER.println(<span class="string">"!!! down"</span>);</span><br><span class="line">  pinMode(PIN_DOWN, OUTPUT);</span><br><span class="line">  digitalWrite(PIN_DOWN, <span class="number">0</span>);</span><br><span class="line">  delay(MOTOR_CTRL_PULSE);</span><br><span class="line">  digitalWrite(PIN_DOWN, <span class="number">1</span>);</span><br><span class="line">  pinMode(PIN_DOWN, INPUT_PULLUP);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">motor_stop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  DEBUG_SER.println(<span class="string">"!!! stop"</span>);</span><br><span class="line">  pinMode(PIN_STOP, OUTPUT);</span><br><span class="line">  digitalWrite(PIN_STOP, <span class="number">0</span>);</span><br><span class="line">  delay(MOTOR_CTRL_PULSE);</span><br><span class="line">  digitalWrite(PIN_STOP, <span class="number">1</span>);</span><br><span class="line">  pinMode(PIN_STOP, INPUT_PULLUP);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_4byte</span><span class="params">(<span class="keyword">int</span> addr, <span class="keyword">uint32_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">//EEPROM.write(addr, value &amp; 0xff);</span></span><br><span class="line">  <span class="comment">//EEPROM.write(addr + 1, (value &gt;&gt; 8) &amp; 0xff);</span></span><br><span class="line">  <span class="comment">//EEPROM.write(addr + 2, (value &gt;&gt; 16) &amp; 0xff);</span></span><br><span class="line">  <span class="comment">//EEPROM.write(addr + 3, (value &gt;&gt; 24) &amp; 0xff);</span></span><br><span class="line">  eeprom_write_block((<span class="keyword">const</span> <span class="keyword">void</span> *)&amp;value, (<span class="keyword">void</span> *)addr, <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">restore_4byte</span><span class="params">(<span class="keyword">int</span> addr, <span class="keyword">uint32_t</span> *value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">//long v;</span></span><br><span class="line">  <span class="comment">//uint8_t tmp;</span></span><br><span class="line">  <span class="comment">//tmp = EEPROM.read(addr);</span></span><br><span class="line">  <span class="comment">//v = tmp &amp; 0xff;</span></span><br><span class="line">  <span class="comment">//tmp = EEPROM.read(addr+1);</span></span><br><span class="line">  <span class="comment">//v |= (tmp &lt;&lt; 8);</span></span><br><span class="line">  <span class="comment">//tmp = EEPROM.read(addr + 2);</span></span><br><span class="line">  <span class="comment">//v |= (tmp &lt;&lt; 16);</span></span><br><span class="line">  <span class="comment">//tmp = EEPROM.read(addr + 3);</span></span><br><span class="line">  <span class="comment">//v |= (tmp &lt;&lt; 24);</span></span><br><span class="line">  <span class="comment">//*value = v;</span></span><br><span class="line">  eeprom_read_block((<span class="keyword">void</span> *)value, (<span class="keyword">void</span> *)addr, <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_len_to_eeprom</span><span class="params">(<span class="keyword">int32_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  save_4byte(<span class="number">0</span>, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">restore_len_from_eeprom</span><span class="params">(<span class="keyword">int32_t</span> *value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  restore_4byte(<span class="number">0</span>, (<span class="keyword">uint32_t</span> *)value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_pos_to_eeprom</span><span class="params">(<span class="keyword">int32_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  DEBUG_SER.print(<span class="string">"=&gt; save pos to eep: "</span>);</span><br><span class="line">  DEBUG_SER.println(value);</span><br><span class="line">  </span><br><span class="line">  save_4byte(<span class="number">4</span>, value);</span><br><span class="line">  last_saved_pos = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">restore_pos_from_eeprom</span><span class="params">(<span class="keyword">int32_t</span> *value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  restore_4byte(<span class="number">4</span>, (<span class="keyword">uint32_t</span> *)value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Python-script-in-OpenWrt"><a href="#Python-script-in-OpenWrt" class="headerlink" title="Python script in OpenWrt"></a>Python script in OpenWrt</h3><p>The MT7688 runs the OpenWrt system, it’s easy to program very complex logic there. I used my favorite programming language - <code>Python</code>. What I wrote is a bridge, between the Serial and MQTT.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> atexit</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"><span class="keyword">import</span> paho.mqtt.client <span class="keyword">as</span> mqtt</span><br><span class="line"><span class="keyword">import</span> serial</span><br><span class="line"></span><br><span class="line">SERIAL_PORT = <span class="string">'/dev/ttyS0'</span></span><br><span class="line">SERIAL_BAUDRATE = <span class="number">57600</span></span><br><span class="line"></span><br><span class="line">MQTT_SERVER = <span class="string">'192.168.4.48'</span></span><br><span class="line">MQTT_PORT = <span class="number">1883</span></span><br><span class="line">MQTT_USER = <span class="string">'xxx'</span></span><br><span class="line">MQTT_PWD = <span class="string">'xxx'</span></span><br><span class="line">MQTT_CLIENTID = <span class="string">'autorack'</span></span><br><span class="line">MQTT_KEEPALIVE_INTERVAL = <span class="number">15</span></span><br><span class="line">MQTT_ALIVE_TOPIC = <span class="string">'rack/alive'</span></span><br><span class="line">MQTT_CMD_TOPIC = <span class="string">"rack/cmd"</span></span><br><span class="line">MQTT_SETPOS_TOPIC = <span class="string">"rack/setpos"</span></span><br><span class="line">MQTT_STATE_TOPIC = <span class="string">"rack/state"</span></span><br><span class="line">MQTT_CALIBRATE_TOPIC = <span class="string">"rack/calibrate"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Serial</span></span><br><span class="line">ser = serial.Serial(SERIAL_PORT, SERIAL_BAUDRATE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># MQTT</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_connect</span><span class="params">(client, userdata, flags, rc)</span>:</span></span><br><span class="line">    print(<span class="string">"Connected with result code "</span>+str(rc))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Subscribing in on_connect() means that if we lose the connection and</span></span><br><span class="line">    <span class="comment"># reconnect then subscriptions will be renewed.</span></span><br><span class="line">    client.publish(MQTT_ALIVE_TOPIC, <span class="string">'online'</span>, qos=<span class="number">0</span>, retain=<span class="keyword">True</span>)</span><br><span class="line">    client.subscribe(MQTT_CMD_TOPIC)</span><br><span class="line">    client.subscribe(MQTT_SETPOS_TOPIC)</span><br><span class="line">    client.subscribe(MQTT_CALIBRATE_TOPIC)</span><br><span class="line"></span><br><span class="line">    userdata.reset_input_buffer()</span><br><span class="line">    userdata.reset_output_buffer()</span><br><span class="line"></span><br><span class="line"><span class="comment"># The callback for when a PUBLISH message is received from the server.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span><span class="params">(client, userdata, msg)</span>:</span></span><br><span class="line">    print(msg.topic+<span class="string">" "</span>+str(msg.payload))</span><br><span class="line">    <span class="keyword">if</span> msg.topic == MQTT_SETPOS_TOPIC:</span><br><span class="line">        userdata.write(<span class="string">'POS'</span> + msg.payload + <span class="string">'\r'</span>)</span><br><span class="line">    <span class="keyword">elif</span> msg.topic == MQTT_CALIBRATE_TOPIC <span class="keyword">and</span> msg.payload.startswith(<span class="string">'C'</span>):</span><br><span class="line">        userdata.write(msg.payload + <span class="string">'\r'</span>)</span><br><span class="line">    <span class="keyword">elif</span> msg.topic == MQTT_CMD_TOPIC:</span><br><span class="line">        userdata.write(msg.payload + <span class="string">'\r'</span>)</span><br><span class="line"></span><br><span class="line">client = mqtt.Client(client_id=MQTT_CLIENTID, userdata=ser)</span><br><span class="line">client.will_set(MQTT_ALIVE_TOPIC, payload=<span class="string">'offline'</span>, qos=<span class="number">0</span>, retain=<span class="keyword">True</span>)</span><br><span class="line">client.username_pw_set(MQTT_USER, password=MQTT_PWD)</span><br><span class="line">client.on_connect = on_connect</span><br><span class="line">client.on_message = on_message</span><br><span class="line">client.connect(MQTT_SERVER, MQTT_PORT, MQTT_KEEPALIVE_INTERVAL)</span><br><span class="line">client.loop_start()</span><br><span class="line"></span><br><span class="line"><span class="comment">## Exit handlers ##</span></span><br><span class="line"><span class="comment"># This function stops python from printing a stacktrace when you hit control-C</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">SIGINTHandler</span><span class="params">(signum, frame)</span>:</span></span><br><span class="line">    <span class="keyword">raise</span> SystemExit</span><br><span class="line"></span><br><span class="line"><span class="comment"># This function lets you run code on exit, including functions from myDigitalLightSensor</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exitHandler</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"Exiting"</span>)</span><br><span class="line">    client.loop_stop()</span><br><span class="line">    ser.close()</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Register exit handlers</span></span><br><span class="line">signal.signal(signal.SIGINT, SIGINTHandler)</span><br><span class="line">atexit.register(exitHandler)</span><br><span class="line"></span><br><span class="line">line = <span class="string">b''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    c = ser.read()</span><br><span class="line">    <span class="keyword">if</span> c == <span class="string">b'\r'</span> <span class="keyword">or</span> c == <span class="string">b'\n'</span>:</span><br><span class="line">        <span class="comment"># handle line</span></span><br><span class="line">        line = line.strip()</span><br><span class="line">        <span class="keyword">if</span> line:</span><br><span class="line">          client.publish(MQTT_STATE_TOPIC, line)</span><br><span class="line">          line = <span class="string">b''</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        line += c</span><br></pre></td></tr></table></figure>
<p>Save this script to /root/mqtt2serial.py, and add it to rc.local to let it startup at boot.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> vim /etc/rc.local</span><br><span class="line"><span class="meta">#</span> insert the following line before the line "exit 0"</span><br><span class="line">/root/mqtt2serial.py &gt; /root/log.txt</span><br></pre></td></tr></table></figure>
<h2 id="Home-Assistant-Configuration"><a href="#Home-Assistant-Configuration" class="headerlink" title="Home Assistant Configuration"></a>Home Assistant Configuration</h2><p>The dryer can be seen as a <code>Cover</code> device in home-assistant. With the MQTT topics exposed in the bridge script, we can configure this cover in home-assistant’s configuration file like this:</p>
<p><code>configuration.yaml</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cover:</span></span><br><span class="line"><span class="attr">  - platform:</span> <span class="string">mqtt</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">"Clothes Dryer"</span></span><br><span class="line"><span class="attr">    command_topic:</span> <span class="string">"rack/cmd"</span></span><br><span class="line"><span class="attr">    set_position_topic:</span> <span class="string">"rack/setpos"</span></span><br><span class="line"><span class="attr">    state_topic:</span> <span class="string">"rack/state"</span></span><br><span class="line"><span class="attr">    availability_topic:</span> <span class="string">"rack/alive"</span></span><br><span class="line"><span class="attr">    qos:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    payload_open:</span> <span class="string">"OPEN"</span></span><br><span class="line"><span class="attr">    payload_close:</span> <span class="string">"CLOSE"</span></span><br><span class="line"><span class="attr">    payload_stop:</span> <span class="string">"STOP"</span></span><br><span class="line"><span class="attr">    state_open:</span> <span class="string">"open"</span></span><br><span class="line"><span class="attr">    state_closed:</span> <span class="string">"closed"</span></span><br><span class="line"><span class="attr">    payload_available:</span> <span class="string">"online"</span></span><br><span class="line"><span class="attr">    payload_not_available:</span> <span class="string">"offline"</span></span><br><span class="line"><span class="attr">    optimistic:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">switch:</span></span><br><span class="line"><span class="attr">  - platform:</span> <span class="string">mqtt</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">"Clothes Dryer Calibrate C0"</span></span><br><span class="line"><span class="attr">    command_topic:</span> <span class="string">"rack/calibrate"</span></span><br><span class="line"><span class="attr">    payload_on:</span> <span class="string">"C0"</span></span><br><span class="line"><span class="attr">    payload_off:</span> <span class="string">"Null"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - platform:</span> <span class="string">mqtt</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">"Clothes Dryer Calibrate C100"</span></span><br><span class="line"><span class="attr">    command_topic:</span> <span class="string">"rack/calibrate"</span></span><br><span class="line"><span class="attr">    payload_on:</span> <span class="string">"C100"</span></span><br><span class="line"><span class="attr">    payload_off:</span> <span class="string">"Null"</span></span><br></pre></td></tr></table></figure></p>
<p>Those two switches are used to calibrate the 0 and 100 position of the cover device in the home-assistant. Use the physical button of the motor controller to control the dryer rack move to the top (the position that you’re comfortable with), switch on the home-assistant switch <code>Clothes Dryer Calibrate C0</code> to remember the 0 position, then switch off <code>Clothes Dryer Calibrate C0</code>. Again use the physical button of the motor controller to control the dryer rack move to the bottom, switch on the home-assistant switch <code>Clothes Dryer Calibrate C100</code> to remember the 100 position, then switch off <code>Clothes Dryer Calibrate C100</code>. Now you can control the dryer rack within home-assistant GUI.</p>
<p><img src="/2018/02/03/build-an-automatic-clothes-dryer/homeassistant.png" alt=""></p>
<p>Position 100 means to lower down the rack to the bottom.</p>
<h2 id="Video"><a href="#Video" class="headerlink" title="Video"></a>Video</h2><div class="video-container"><iframe src="//www.youtube.com/embed/-icKRQRksM4" frameborder="0" allowfullscreen></iframe></div>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/tech/" rel="tag"># tech</a>
          
            <a href="/tags/mqtt/" rel="tag"># mqtt</a>
          
            <a href="/tags/home-assistant/" rel="tag"># home-assistant</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/03/09/work-around-for-macos-mail-app-eating-high-cpu/" rel="next" title="Work around for macOS Mail.app eating high CPU">
                <i class="fa fa-chevron-left"></i> Work around for macOS Mail.app eating high CPU
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">KillingJacky</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/KillingJacky" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://twitter.com/KillingJacky" target="_blank" title="Twitter">
                    
                      <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Programming"><span class="nav-number">1.</span> <span class="nav-text">Programming</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Arduino"><span class="nav-number">1.1.</span> <span class="nav-text">Arduino</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Python-script-in-OpenWrt"><span class="nav-number">1.2.</span> <span class="nav-text">Python script in OpenWrt</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Home-Assistant-Configuration"><span class="nav-number">2.</span> <span class="nav-text">Home Assistant Configuration</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Video"><span class="nav-number">3.</span> <span class="nav-text">Video</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">KillingJacky</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    
      <script id="dsq-count-scr" src="https://forkthings.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://forkthings.com/2018/02/03/build-an-automatic-clothes-dryer/';
          this.page.identifier = '2018/02/03/build-an-automatic-clothes-dryer/';
          this.page.title = 'Build an Automatic Clothes Dryer';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://forkthings.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
